---
title: "2_AnalyzeData"
author: "Nina-Alisa Kollakowski"
date: "`r Sys.Date()`"
output: html_document
---

## Initializing
```{r}
library(dplyr)
library(mice)
library(psych)
#library(semTools)
library(lavaan)

nImputations <- 500
```

## Defining measures

```{r}
##defining measures----
implicitSelfMeasures <- c("spatialContingency_looking", 
                          "spatialContingency_legs", 
                          "temporalContingency_looking",
                          "temporalContingency_left",
                          "temporalContingency_right",
                          "reaching_arm",
                          "reaching_head",
                          "sensoryAttenuation_pos",
                          "sensoryAttenuation_neg")
explicitSelfMeasures <- c("mirrorSelfRecognition", 
                          "videoSelfRecognition", 
                          "bodySizeDoor_errors",
                          "bodySizeToys_errors", 
                          "bodyObstacle_errors", 
                          "selfUnderstanding_passed", 
                          "placing_correct")
continuousVariables <- c("spatialContingency_looking", 
                         "spatialContingency_legs", 
                         "temporalContingency_looking",
                         "temporalContingency_left",
                         "temporalContingency_right",
                         "reaching_arm",
                         "reaching_head",
                         "sensoryAttenuation_pos",
                         "sensoryAttenuation_neg",
                         "bodySizeToys_errors", 
                         "bodyObstacle_errors", 
                         "selfUnderstanding_passed", 
                         "placing_correct")
dichotomousVariables <- c("mirrorSelfRecognition", 
                          "videoSelfRecognition", 
                          "bodySizeDoor_errors")
```

##load dataset
```{r}
load("joinedSelfData.RData")
currentData <- selfData
rm(selfData)
nObservations = nrow(currentData)
```

##check for systematic missingness in data
conduct Little's MCAR test to confirm that data is missing at random
```{r}
naniar::mcar_test(currentData) # p = .046
naniar::mcar_test(currentData %>% 
                    filter(if_any(all_of(explicitSelfMeasures), ~ !is.na(.)))) # p = .073
naniar::mcar_test(currentData %>% 
                    select(-starts_with("temporalContingency"),
                           -starts_with("sensoryAttenuation"))) # p = .323
```


##scale dataset
without scaling CFA was giving the warnings that "some observed variances are (at least) a factor 1000 times larger than others; use varTable(fit) to investigate"
```{r}
currentData_scaled <- currentData %>% 
  mutate_at(continuousVariables, 
            ~(scale(.) %>% as.vector)) %>% 
  select(-id)
```

##impute Data
```{r}
#impute 500 different datasets and set seed to make reproducible
imputedData <- mice(currentData_scaled, m = nImputations, print = FALSE, seed = 350)
save(imputedData, file = "imputedData.Rdata")
```

#load imputed dataset
```{r}
load("imputedData.Rdata")
```

## compute correlation matrix for implicit/explicit measures for each imputed dataset
use psych::mixedCor for this
```{r echo=FALSE}
#initialize lists of correlations and standard deviations
correlationData_implicit <- vector("list", nImputations)
correlationData_explicit <- vector("list", nImputations)
standardDeviations_implicit <- vector("list", nImputations)
standardDeviations_explicit <- vector("list", nImputations)

for (i in 1:nImputations){
  #extract current imputed dataset
  curDataset <- complete(imputedData, action = i)
  
  #compute standard deviations of measures as a matrix as needed for covariance matrix
  standardDeviations_implicit[[i]] <- diag(sapply(curDataset %>%
                                                    select(all_of(implicitSelfMeasures)),
                                                  sd)) #implicit
  
  standardDeviations_explicit[[i]] <- diag(sapply(curDataset %>%
                                                    select(all_of(explicitSelfMeasures)), 
                                                  sd)) #explicit
  
  #calculate correlations of implicit measures    
  correlationData_implicit[[i]] <- mixedCor(curDataset %>%
                                              select(all_of(implicitSelfMeasures)),
                                            c = intersect(implicitSelfMeasures, continuousVariables),
                                            d = intersect(implicitSelfMeasures, dichotomousVariables))$rho 
  
  #calculate correlations of explicit measures
  correlationData_explicit[[i]] <- mixedCor(curDataset %>%
                                              select(all_of(explicitSelfMeasures)),
                                            c = intersect(explicitSelfMeasures, continuousVariables),
                                            d = intersect(explicitSelfMeasures, dichotomousVariables))$rho 
}
rm(curDataset)
```

## create covariance matrix from each correlation matrix
```{r}
#initialize lists of covariances
covarianceData_implicit <- vector("list", nImputations)
covarianceData_explicit <- vector("list", nImputations)

for (i in 1:nImputations){
  covarianceData_implicit[[i]] <- standardDeviations_implicit[[i]] %*% correlationData_implicit[[i]] %*% standardDeviations_implicit[[i]]
  
  covarianceData_explicit[[i]] <- standardDeviations_explicit[[i]] %*% correlationData_explicit[[i]] %*% standardDeviations_explicit[[i]]
}
```

## create average matrices for implicit/explicit measures
```{r}
covariance_implicit <- apply(simplify2array(covarianceData_implicit), c(1,2), mean)
rownames(covariance_implicit) <- implicitSelfMeasures
colnames(covariance_implicit) <- implicitSelfMeasures

covariance_explicit <- apply(simplify2array(covarianceData_explicit), c(1,2), mean)
rownames(covariance_explicit) <- explicitSelfMeasures
colnames(covariance_explicit) <- explicitSelfMeasures

correlation_implicit <- apply(simplify2array(correlationData_implicit), c(1,2), mean)
rownames(correlation_implicit) <- implicitSelfMeasures
colnames(correlation_implicit) <- implicitSelfMeasures

correlation_explicit <- apply(simplify2array(correlationData_explicit), c(1,2), mean)
rownames(correlation_explicit) <- explicitSelfMeasures
colnames(correlation_explicit) <- explicitSelfMeasures

```


## compute CFA of implicit/explicit measures
MLR estimator
evaluate fit using X2-test, RMSEA, SRMR, CFI
good fit if 3/4 indicators suggest good fit
X2 = non-significant
RMSEA < .08
SRMR <.11
CFI >.95
```{r CFA implicit}
implicitCFA.model <- 'implicit =~ spatialContingency_looking + 
                                  spatialContingency_legs + 
                                  temporalContingency_looking + 
                                  temporalContingency_left +
                                  temporalContingency_right + 
                                  reaching_arm +
                                  reaching_head +
                                  sensoryAttenuation_pos +
                                  sensoryAttenuation_neg'
implicitCFA <- cfa(implicitCFA.model, sample.cov = covariance_implicit, sample.nobs = nObservations) 
summary(implicitCFA)
fitMeasures(implicitCFA, fit.measures = c("rmsea", "srmr", "cfi"))
```
significant X2-test (p = 0.000) -> bad
RMSEA > .08 (0.151) -> bad
SRMR > .11 (0.123) -> bad
CFI < .95 (0.302) -> bad
all indicators show bad fit of CFA for implicit measures -> perform EFA
```{r CFA explicit}
explicitCFA.model <- 'explicit =~ mirrorSelfRecognition + 
                                  videoSelfRecognition + 
                                  bodySizeDoor_errors + 
                                  bodySizeToys_errors +
                                  bodyObstacle_errors + 
                                  selfUnderstanding_passed +
                                  placing_correct'
explicitCFA <- cfa(explicitCFA.model, sample.cov = covariance_explicit, sample.nobs = nObservations) 
summary(explicitCFA)
fitMeasures(explicitCFA, fit.measures = c("rmsea", "srmr", "cfi"))
```
significant X2-test (p = 0.019) -> bad
RMSEA > .08 (0.089) -> bad
SRMR < .11 (0.075) -> good
CFI < .95 (0.692) -> bad
3/4 indicators show bad fit of CFA for explicit measures -> perform EFA

##perform EFA for implicit measures
1) Bartlett's test to check if correlation matrix different from identity matrix (needs to be significant)
```{r Bartlett}
cortest.bartlett(correlation_implicit, n = nObservations) #significant -> proceed
```

2) KMO >.5, otherwise exclude variables with smallest KMO until criterion is reached
```{r KMO}
KMO(correlation_implicit) #KMO = 0.47, exclude temporalContingency_left (0.42)
correlation_implicit1 <- correlation_implicit[!rownames(correlation_implicit) == "temporalContingency_left",
                                              !colnames(correlation_implicit) == "temporalContingency_left"]
excludedVariables_implicit_KMO <- list("temporalContingency_left")
excludedVariables_implicit <- list("temporalContingency_left")

#run KMO again
KMO(correlation_implicit1) #KMO = 0.51 -> proceed

```

3) parallel analysis with reduced correlation matrix to decide number of factors

```{r parallel analysis}
fa.parallel(correlation_implicit1, n.obs = nObservations, n.iter = 1000, fm = "ml", fa = "fa")
```
parallel analysis suggests 3 factors      

4) run EFA with principal axis factoring with oblique (direct oblimin) rotation
```{r EFA}
#run EFA with 3 factors as suggested by parallel analysis
efa.implicit <- fa(correlation_implicit1, nfactors = 3, n.obs = nObservations, 
                   rotate = 'oblimin', fm = 'pa')

#print results: cut-off of .4 as only loadings with >=.4 will be assigned to this factor
print.psych(efa.implicit, cut = .4, digits=3, sort=TRUE) 

#exclude variables that don't load on any factor with loading of >=.4
excludedVariables_implicit <- append(excludedVariables_implicit, c("temporalContingency_looking",
                                                                   "sensoryAttenuation_neg",
                                                                   "sensoryAttenuation_pos"))

```

5) assign variables to factors with loadings of >=.4
```{r assign to factors}
#extract factor loading from EFA
relevantFactorLoadings_implicit <- efa.implicit$loadings

#replace loadings < 0.4 with 0 for correct calculation of factor scores
relevantFactorLoadings_implicit[abs(relevantFactorLoadings_implicit) < 0.4] <- 0
```

6) calculate factor scores
```{r factor scores}
#initialize lists for factor scores and all excluded variables
factorScores_implicit <- vector("list", nImputations)
otherVariables_implicit <- vector("list", nImputations)

#calculate factor scores and scores for excluded variables for each imputed dataset
for (i in 1:nImputations){
  curDataset <- complete(imputedData, action = i)
  
   factorScore_buffer <- curDataset %>%
    select(all_of(setdiff(implicitSelfMeasures, excludedVariables_implicit_KMO))) %>%
    factor.scores(x = ., relevantFactorLoadings_implicit)
  
  factorScores_implicit[[i]] <- factorScore_buffer$scores
  
  otherVariables_implicit[[i]] <- data.matrix(curDataset %>%
    select(all_of(simplify2array(excludedVariables_implicit))))
}
rm(factorScore_buffer)
rm(curDataset)

#create average factor scores and excluded variable scores for all datasets
factorScores_implicit_avg <- apply(simplify2array(factorScores_implicit), c(1,2), mean)
otherVariables_implicit_avg <- apply(simplify2array(otherVariables_implicit), c(1,2), mean)

#combine factor scores and scores for excluded variables into dataframe for implicit self
implicitSelf <- cbind(as.data.frame(factorScores_implicit_avg), as.data.frame(otherVariables_implicit_avg))
implicitSelf <- implicitSelf %>%
   rename(implicitFactor1 = PA1,
          implicitFactor2 = PA2,
          implicitFactor3 = PA3) %>%
  mutate(id = 1:nObservations)
```


## perform EFA for explicit measures
1) Bartlett's test to check if correlation matrix different from identity matrix (needs to be significant)
```{r Bartlett}
cortest.bartlett(correlation_explicit, n = nObservations) #significant -> proceed
```

2) KMO >.5, otherwise exclude variables with smallest KMO until criterion is reached
```{r KMO}
KMO(correlation_explicit) #KMO = 0.53 -> proceed
```

3) parallel analysis with reduced correlation matrix to decide number of factors

```{r parallel analysis}
fa.parallel(correlation_explicit, n.obs = nObservations, n.iter = 1000, fm = "ml", fa = "fa")
```
parallel analysis suggests 4 factors  

4) run EFA with principal axis factoring with oblique (direct oblimin) rotation
```{r EFA}
#run EFA with 3 factors as suggested by parallel analysis
efa.explicit <- fa(correlation_explicit, nfactors = 4, n.obs = nObservations, 
                   rotate = 'oblimin', fm = 'pa')

#print results: cut-off of .4 as only loadings with >=.4 will be assigned to this factor
print.psych(efa.explicit, cut = .4, digits=3, sort=TRUE) 
```

5) assign variables to factors with loadings of >=.4
```{r assign to factors}
#extract factor loading from EFA
relevantFactorLoadings_explicit <- efa.explicit$loadings

#replace loadings < 0.4 with 0 for correct calculation of factor scores
relevantFactorLoadings_explicit[abs(relevantFactorLoadings_explicit) < 0.4] <- 0
```

6) calculate factor scores
```{r factor scores}
#initialize lists for factor scores and all excluded variables
factorScores_explicit <- vector("list", nImputations)

#calculate factor scores and scores for excluded variables for each imputed dataset
for (i in 1:nImputations){
  curDataset <- complete(imputedData, action = i)
  
   factorScore_buffer <- curDataset %>%
    select(all_of(explicitSelfMeasures)) %>%
    factor.scores(x = ., relevantFactorLoadings_explicit)
  
  factorScores_explicit[[i]] <- factorScore_buffer$scores
}
rm(factorScore_buffer)
rm(curDataset)

#create average factor scores and excluded variable scores for all datasets
factorScores_explicit_avg <- apply(simplify2array(factorScores_explicit), c(1,2), mean)

#combine factor scores and scores for excluded variables into dataframe for implicit self
explicitSelf <- as.data.frame(factorScores_explicit_avg) %>%
   rename(explicitFactor1 = PA1,
          explicitFactor2 = PA2,
          explicitFactor3 = PA3,
          explicitFactor4 = PA4) %>%
  mutate(id = 1:nObservations)
```

## linear regressions of implicit -> explicit self
run regressions of each explicit factor/variable with all implicit factors/variables as predictors
```{r prepare dataframe}
#merge implicit and explicit dataset
selfData <- merge(implicitSelf, explicitSelf, by = "id")
```

```{r explicit factor 1}
explicitFactor1.model <- lm(explicitFactor1 ~ implicitFactor1 + 
                              implicitFactor2 + 
                              implicitFactor3 + 
                              temporalContingency_left + 
                              temporalContingency_looking + 
                              sensoryAttenuation_neg + 
                              sensoryAttenuation_pos, 
                            data = selfData)
summary(explicitFactor1.model)
```
```{r explicit factor 2}
explicitFactor2.model <- lm(explicitFactor2 ~ implicitFactor1 + 
                              implicitFactor2 + 
                              implicitFactor3 + 
                              temporalContingency_left + 
                              temporalContingency_looking + 
                              sensoryAttenuation_neg + 
                              sensoryAttenuation_pos, 
                            data = selfData)
summary(explicitFactor2.model)
```
```{r explicit factor 3}
explicitFactor3.model <- lm(explicitFactor3 ~ implicitFactor1 + 
                              implicitFactor2 + 
                              implicitFactor3 + 
                              temporalContingency_left + 
                              temporalContingency_looking + 
                              sensoryAttenuation_neg + 
                              sensoryAttenuation_pos, 
                            data = selfData)
summary(explicitFactor3.model)
```
```{r explicit factor 4}
explicitFactor4.model <- lm(explicitFactor4 ~ implicitFactor1 + 
                              implicitFactor2 + 
                              implicitFactor3 + 
                              temporalContingency_left + 
                              temporalContingency_looking + 
                              sensoryAttenuation_neg + 
                              sensoryAttenuation_pos, 
                            data = selfData)
summary(explicitFactor4.model)
```
