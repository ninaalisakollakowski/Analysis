---
title: "2_AnalyzeData"
author: "Nina-Alisa Kollakowski"
date: "`r Sys.Date()`"
output: html_document
---

## Initializing
```{r}
library(dplyr)
library(mice)
library(psych)
library(semTools)
#library(lavaan)
```

## Defining measures

```{r}
##defining measures----
implicitSelfMeasures <- c("spatialContingency_looking", 
                          "spatialContingency_legs", 
                          "temporalContingency_looking",
                          "temporalContingency_left",
                          "temporalContingency_right",
                          "reaching_arm",
                          "reaching_head",
                          "sensoryAttenuation_pos",
                          "sensoryAttenuation_neg")
explicitSelfMeasures <- c("mirrorSelfRecognition", 
                          "videoSelfRecognition", 
                          "bodySizeDoor_errors",
                          "bodySizeToys_errors", 
                          "bodyObstacle_errors", 
                          "selfUnderstanding_passed", 
                          "placing_correct")
continuousVariables <- c("spatialContingency_looking", 
                         "spatialContingency_legs", 
                         "temporalContingency_looking",
                         "temporalContingency_left",
                         "temporalContingency_right",
                         "reaching_arm",
                         "reaching_head",
                         "sensoryAttenuation_pos",
                         "sensoryAttenuation_neg",
                         "bodySizeToys_errors", 
                         "bodyObstacle_errors", 
                         "selfUnderstanding_passed", 
                         "placing_correct")
dichotomousVariables <- c("mirrorSelfRecognition", 
                          "videoSelfRecognition", 
                          "bodySizeDoor_errors")
```

##load dataset
```{r}
load("joinedSelfData.RData")
currentData <- selfData
rm(selfData)
```

##scale dataset
without scaling CFA was giving the warnings that "some observed variances are (at least) a factor 1000 times larger than others; use varTable(fit) to investigate"

```{r}
currentData_scaled <- currentData %>% 
  mutate_at(continuousVariables, 
            ~(scale(.) %>% as.vector)) %>% 
  select(-id)
```



##impute Data
```{r}
#impute 500 different datasets and set seed to make reproducible
nImputations <- 500
imputedData <- mice(currentData_scaled, m = nImputations, print = FALSE, seed = 350)
save(imputedData, file = "imputedData.Rdata")
```

#load imputed dataset
```{r}
load("imputedData.Rdata")
```

## compute correlation matrix for implicit/explicit measures for each imputed dataset
use psych::mixedCor for this
```{r echo=FALSE}
#initialize lists of correlations and standard deviations
correlationData_implicit <- vector("list", nImputations)
correlationData_explicit <- vector("list", nImputations)
standardDeviations <- vector("list", nImputations)

for (i in 1:nImputations){
  #extract current imputed dataset
  curDataset <- complete(imputedData, action = i)
  
  #compute standard deviations of measures as needed for covariance matrix
  standardDeviations[[i]] <- sapply(curDataset, sd)

  #calculate correlations of implicit measures    
  correlationData_implicit[[i]] <- mixedCor(curDataset %>%
                                              select(all_of(implicitSelfMeasures)),
                                            c = intersect(implicitSelfMeasures, continuousVariables),
                                            d = intersect(implicitSelfMeasures, dichotomousVariables))$rho 
  
  #calculate correlations of explicit measures
  correlationData_explicit[[i]] <- mixedCor(curDataset %>%
                                              select(all_of(explicitSelfMeasures)),
                                            c = intersect(explicitSelfMeasures, continuousVariables),
                                            d = intersect(explicitSelfMeasures, dichotomousVariables))$rho 
}
```

## create covariance matrix from each correlation matrix

## create average covariance matrix for implicit/explicit measures

## compute CFA ofr implicit/explicit measures
MLR estimator
evaluate fit using X2-test, RMSEA, SRMR, CFI
good fit if 3/4 indicators suggest good fit
X2 = non-significant
RMSEA < .08
SRMR <.11
CFI >.95

## eventually perform EFA for implicit/explicit measures
1) Bartlett's test to check if correlation matrix different from identity matrix (needs to be significant)
2) KMO >.5, otherwise exclude variables with smallest KMO until criterion is reached
3) parallel analysis with reduced correlation matrix to decide number of factors
4) run EFA with principal axis factoring with oblique (direct oblimin) rotation
5) assign variables to factors with loadings of >=.4
6) calculate factor scores

## linear regressions of implicit -> explicit self




